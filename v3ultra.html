<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Battery & Memory DrainÂ â€“Â v3Â Ultra</title>
  <style>
    html,body{margin:0;padding:0;background:#000;color:#fff;
      font-family:sans-serif;text-align:center;overflow:hidden;}
    canvas{position:absolute;top:0;left:0;display:block;}
    /* Control panel */
    #panel{position:fixed;top:0;left:0;width:100%;z-index:20;
      background:rgba(0,0,0,.8);padding:8px 0;}
    #panel button{margin:0 8px;padding:6px 14px;font-size:16px;
      background:#222;border:1px solid #555;border-radius:4px;color:#fff;}
    #stats{position:fixed;bottom:0;left:0;width:100%;z-index:20;
      background:rgba(0,0,0,.8);padding:6px 0;display:none;font-size:14px;}
    h1,p{z-index:10;position:relative;margin:1rem 0 0;}
  </style>
</head>
<body>
  <div id="panel">
    <button id="startBtn">â–¶ï¸ŽÂ Start</button>
    <button id="stopBtn">â– Â Stop</button>
    <button id="statsBtn">â„¹ï¸ŽÂ Stats</button>
  </div>

  <h1>ðŸ’€Â Batteryâ€¯&â€¯Memoryâ€¯DrainÂ â€”Â v3Â Ultra</h1>
  <p>TapÂ <strong>Start</strong> to unleash CPU, GPU, sensors and a 100â€¯MB memory bump (â‰ˆâ€¯180â€¯MB total).</p>

  <canvas id="canvas1"></canvas>
  <canvas id="canvas2"></canvas>
  <canvas id="webgl"></canvas>

  <div id="stats"></div>

<script>
(() => {
  /* ---------- globals ---------- */
  let running = false;
  let wakeLock = null;
  let workers = [];
  let gpsTimer = null;
  let frameCounter = 0, fps = 0;
  let batteryLevel = 'n/a';
  const memBuffers = [];         // holds the 100â€¯MB buffer

  /* ---------- DOM ---------- */
  const c1 = document.getElementById('canvas1');
  const c2 = document.getElementById('canvas2');
  const webglCanvas = document.getElementById('webgl');
  const ctx1 = c1.getContext('2d');
  const ctx2 = c2.getContext('2d');
  const statsDiv = document.getElementById('stats');

  function resizeAll(){
    [c1,c2,webglCanvas].forEach(c=>{
      c.width = innerWidth;
      c.height = innerHeight;
    });
  }
  addEventListener('resize',resizeAll); resizeAll();

  /* ---------- ScreenÂ WakeÂ Lock ---------- */
  async function requestWakeLock(){
    if(!('wakeLock' in navigator)) return;
    try{
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release',()=>console.log('Wakeâ€‘lock released'));
      console.log('Screen wakeâ€‘lock acquired');
    }catch(e){console.warn('Wakeâ€‘lock failed:',e);}
  }
  function releaseWakeLock(){ if(wakeLock){wakeLock.release(); wakeLock=null;} }

  /* ---------- stats overlay ---------- */
  setInterval(()=>{
    fps = frameCounter; frameCounter = 0;
    if(statsDiv.style.display!=='none'){
      const memMB = (performance.memory?.usedJSHeapSize || 0) / 1048576;
      statsDiv.textContent =
        `FPSÂ ${fps}Â |Â BatteryÂ ${batteryLevel}Â |Â JS HeapÂ ${memMB.toFixed(0)}â€¯MB`;
    }
  },1000);

  if(navigator.getBattery){
    navigator.getBattery().then(b=>{
      const update = ()=>{batteryLevel = Math.round(b.level*100)+'%';};
      update(); b.addEventListener('levelchange',update);
    });
  }

  /* ---------- main workload ---------- */
  function startTest(){
    if(running) return; running = true;
    requestWakeLock();

    /* --- memory bump: single 100â€¯MB ArrayBuffer --- */
    try{
      const BYTES_100MB = 100 * 1048576;
      memBuffers[0] = new ArrayBuffer(BYTES_100MB);
      console.log('Allocated 100â€¯MB buffer (â‰ˆÂ 180â€¯MB total with canvases etc.)');
    }catch(e){ console.warn('Allocation failed:', e); }

    /* --- 2â€‘D canvas noise --- */
    function drawCanvas(ctx){
      ctx.fillStyle=`hsl(${Math.random()*360},100%,50%)`;
      ctx.fillRect(Math.random()*ctx.canvas.width,
                   Math.random()*ctx.canvas.height,50,50);
      frameCounter++;
      if(running) requestAnimationFrame(()=>drawCanvas(ctx));
    }
    drawCanvas(ctx1); drawCanvas(ctx2);

    /* --- WebGL shader flood --- */
    const gl = webglCanvas.getContext('webgl');
    const vsSrc=`attribute vec4 p;void main(){gl_Position=p;}`;
    const fsSrc=`precision mediump float;
      void main(){float r=mod(gl_FragCoord.x*gl_FragCoord.y,255.0)/255.0;
      float g=mod(gl_FragCoord.y,255.0)/255.0;
      float b=mod(gl_FragCoord.x,255.0)/255.0;
      gl_FragColor=vec4(r,g,b,1.0);} `;
    const vs = gl.createShader(gl.VERTEX_SHADER);
    gl.shaderSource(vs,vsSrc); gl.compileShader(vs);
    const fs = gl.createShader(gl.FRAGMENT_SHADER);
    gl.shaderSource(fs,fsSrc); gl.compileShader(fs);
    const prog = gl.createProgram();
    gl.attachShader(prog,vs); gl.attachShader(prog,fs); gl.linkProgram(prog);
    gl.useProgram(prog);
    const posBuf = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER,posBuf);
    gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(
      [-1,-1, 1,-1, -1,1, -1,1, 1,-1, 1,1]),gl.STATIC_DRAW);
    const loc = gl.getAttribLocation(prog,'p');
    gl.enableVertexAttribArray(loc);
    gl.vertexAttribPointer(loc,2,gl.FLOAT,false,0,0);
    (function drawWebGL(){
      gl.drawArrays(gl.TRIANGLES,0,6); frameCounter++;
      if(running) requestAnimationFrame(drawWebGL);
    })();

    /* --- DOM colour tween --- */
    (function animateDOM(){
      document.body.style.backgroundColor=
        `hsl(${Math.random()*360},100%,5%)`;
      if(running) requestAnimationFrame(animateDOM);
    })();

    /* --- mainâ€‘thread CPU spin --- */
    (function burnCPU(){
      const st = performance.now();
      while(performance.now()-st<100){ Math.sqrt(Math.random()*1e6); }
      if(running) setTimeout(burnCPU,0);
    })();

    /* --- four busy Workers --- */
    const WORKER_COUNT = 4;
    for(let i=0;i<WORKER_COUNT;i++){
      const blob = new Blob([`onmessage=function(){
        while(true){Math.sqrt(Math.random()*1e6);}}`],
        {type:'application/javascript'});
      const w = new Worker(URL.createObjectURL(blob));
      w.postMessage('start'); workers.push(w);
    }

    /* --- GPS + sensors --- */
    if(navigator.geolocation){
      gpsTimer = setInterval(()=>{
        navigator.geolocation.getCurrentPosition(()=>{},()=>{});
      },1000);
    }
    addEventListener('deviceorientation',orientationHandler);
    addEventListener('devicemotion',motionHandler);
  }

  function stopTest(){
    if(!running) return; running = false;
    releaseWakeLock();

    workers.forEach(w=>w.terminate());
    workers.length = 0;
    clearInterval(gpsTimer);
    memBuffers.length = 0;               // allow GC to reclaim memory
    removeEventListener('deviceorientation',orientationHandler);
    removeEventListener('devicemotion',motionHandler);
    console.log('v3Â Ultra stopped & cleaned up');
  }

  /* sensor callbacks (noâ€‘op) */
  function orientationHandler(e){}
  function motionHandler(e){}

  /* ---------- UI wiring ---------- */
  document.getElementById('startBtn').onclick = startTest;
  document.getElementById('stopBtn').onclick  = stopTest;
  document.getElementById('statsBtn').onclick = () => {
    statsDiv.style.display = statsDiv.style.display==='none' ? 'block' : 'none';
  };
})();
</script>
</body>
</html>
