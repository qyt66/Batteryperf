<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>A18 Pro Stress Test</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; touch-action: none; }
        
        /* The Graphics Layer */
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* The UI Overlay */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; 
            pointer-events: none; /* Let touches pass through empty areas */
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom); /* Respect Home Bar */
        }

        /* The Glass Panel - Explicitly Interactive */
        .panel {
            background: rgba(20, 20, 30, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 30px;
            border-radius: 24px;
            width: 85%;
            max-width: 400px;
            text-align: center;
            pointer-events: auto; /* CRITICAL FIX: Makes this area clickable */
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }

        h1 { margin: 0 0 15px 0; font-size: 18px; letter-spacing: 0.5px; text-transform: uppercase; color: #fff; font-weight: 700; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 25px;
            text-align: left;
        }

        .stat-box {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 12px;
        }

        .label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 4px; }
        .value { font-family: "SF Mono", monospace; font-size: 14px; color: #0f0; font-weight: 600; }
        
        /* The Button - Large and Interactive */
        button {
            -webkit-appearance: none; /* Remove default iOS styling */
            appearance: none;
            width: 100%;
            padding: 18px 0;
            font-size: 18px;
            font-weight: 600;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            pointer-events: auto; /* CRITICAL FIX */
            
            /* Default State */
            background: #007AFF; 
            color: white;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4);
        }

        button:active { transform: scale(0.96); background: #006ee6; }
        
        /* Active State Style */
        button.stop {
            background: #FF3B30;
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4);
        }

        .warn { font-size: 11px; color: #666; margin-top: 15px; display: block; }

    </style>
</head>
<body>

    <canvas id="glCanvas"></canvas>

    <div id="hud">
        <div class="panel">
            <h1>A18 Pro Stress Test</h1>
            
            <div class="metrics-grid">
                <div class="stat-box">
                    <span class="label">Frame Rate</span>
                    <span class="value" id="fpsVal">0 FPS</span>
                </div>
                <div class="stat-box">
                    <span class="label">Resolution</span>
                    <span class="value" id="resVal">--</span>
                </div>
                <div class="stat-box">
                    <span class="label">CPU Threads</span>
                    <span class="value" id="coreVal">Idle</span>
                </div>
                <div class="stat-box">
                    <span class="label">GPS Sensor</span>
                    <span class="value" id="gpsVal">Off</span>
                </div>
            </div>

            <button id="actionBtn" onclick="toggleTest()">START TEST</button> <!-- onclick works now -->
            <span class="warn">Caution: High battery drain & heat generation.</span>
        </div>
    </div>

<script>
    // --- CONFIG & STATE ---
    let isRunning = false;
    let workers = [];
    let animationId;
    let gpsWatchId;
    let frameCount = 0;
    let lastTime = performance.now();

    const ui = {
        fps: document.getElementById('fpsVal'),
        res: document.getElementById('resVal'),
        cores: document.getElementById('coreVal'),
        gps: document.getElementById('gpsVal'),
        btn: document.getElementById('actionBtn')
    };

    // --- GPU SETUP (A18 Optimized) ---
    const canvas = document.getElementById("glCanvas");
    const gl = canvas.getContext("webgl", { 
        powerPreference: "high-performance", 
        antialias: false,
        alpha: false
    });

    // Handle High DPI (Retina)
    function resize() {
        const dpr = window.devicePixelRatio || 1;
        // 16 Pro Max needs full resolution for stress
        canvas.width = window.innerWidth * dpr;
        canvas.height = window.innerHeight * dpr;
        gl.viewport(0, 0, canvas.width, canvas.height);
        ui.res.innerText = `${canvas.width.toFixed(0)} x ${canvas.height.toFixed(0)}`;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- SHADERS (Heavy Compute) ---
    const vsSource = `attribute vec4 p; void main(){gl_Position=p;}`;
    const fsSource = `
        precision highp float;
        uniform float t;
        uniform vec2 r;

        mat2 rot(float a) { float s=sin(a),c=cos(a); return mat2(c,-s,s,c); }

        // Julia Set Fractal Logic for Stress
        float map(vec3 p) {
            p.z -= 1.0; 
            p.xy *= rot(t * 0.2);
            float s = 2.0;
            float d = 1000.0;
            for(int i=0; i<7; i++) { // Heavy Iterations
                p = abs(p) - vec3(0.5, 0.5, 0.5);
                float r2 = dot(p,p);
                float k = max(1.0/r2, 0.5); 
                p *= k;
                s *= k;
            }
            return length(p)/s - 0.01;
        }

        void main() {
            vec2 uv = (gl_FragCoord.xy * 2.0 - r) / r.y;
            vec3 ro = vec3(0.0, 0.0, -2.5);
            vec3 rd = normalize(vec3(uv, 1.0));
            
            float d = 0.0;
            float t_dist = 0.0;
            int i_steps = 0;
            
            // Raymarch
            for(int i=0; i<64; i++) {
                i_steps = i;
                d = map(ro + rd * t_dist);
                t_dist += d;
                if(d < 0.002 || t_dist > 20.0) break;
            }

            // Coloring
            vec3 col = vec3(0.0);
            if(t_dist < 20.0) {
                float glow = float(i_steps)/64.0;
                col = vec3(1.0, 0.5, 0.2) * glow * 4.0;
            }
            gl_FragColor = vec4(col, 1.0);
        }
    `;

    function createShader(type, src) {
        const s = gl.createShader(type);
        gl.shaderSource(s, src);
        gl.compileShader(s);
        if(!gl.getShaderParameter(s, gl.COMPILE_STATUS)) console.error(gl.getShaderInfoLog(s));
        return s;
    }
    const pgm = gl.createProgram();
    gl.attachShader(pgm, createShader(gl.VERTEX_SHADER, vsSource));
    gl.attachShader(pgm, createShader(gl.FRAGMENT_SHADER, fsSource));
    gl.linkProgram(pgm);
    gl.useProgram(pgm);

    gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]), gl.STATIC_DRAW);
    gl.enableVertexAttribArray(0);
    gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

    const locT = gl.getUniformLocation(pgm, "t");
    const locR = gl.getUniformLocation(pgm, "r");

    // --- CPU WORKERS ---
    const workerCode = `
        self.onmessage = function() {
            // Create large buffer to trash L2 Cache/Memory
            const buf = new Float32Array(10000);
            while(true) {
                for(let i=0; i<10000; i++) {
                    // Trigonometry + Memory Writes
                    buf[i] = Math.sin(i) * Math.tan(i);
                }
            }
        };
    `;
    const blob = new Blob([workerCode], {type: 'application/javascript'});
    const blobUrl = URL.createObjectURL(blob);

    // --- CONTROLS ---
    function toggleTest() {
        if(isRunning) {
            stop();
        } else {
            start();
        }
    }

    function start() {
        isRunning = true;
        ui.btn.innerText = "STOP TEST";
        ui.btn.className = "stop";
        
        // 1. Start Render Loop
        loop();

        // 2. Start CPU Load
        const coreCount = navigator.hardwareConcurrency || 6;
        ui.cores.innerText = `${coreCount} Active`;
        ui.cores.style.color = "#ff3b30";
        
        for(let i=0; i<coreCount; i++) {
            const w = new Worker(blobUrl);
            w.postMessage("start");
            workers.push(w);
        }

        // 3. Start GPS
        if(navigator.geolocation) {
            ui.gps.innerText = "Searching...";
            ui.gps.style.color = "#fc0";
            gpsWatchId = navigator.geolocation.watchPosition(
                (p) => {
                    ui.gps.innerText = "Tracking";
                    ui.gps.style.color = "#0f0";
                },
                (e) => {
                    ui.gps.innerText = "Error";
                },
                { enableHighAccuracy: true }
            );
        }
    }

    function stop() {
        isRunning = false;
        cancelAnimationFrame(animationId);
        
        // Kill Workers
        workers.forEach(w => w.terminate());
        workers = [];
        
        // Kill GPS
        if(gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);

        // Reset UI
        ui.btn.innerText = "START TEST";
        ui.btn.className = "";
        ui.cores.innerText = "Idle";
        ui.cores.style.color = "#0f0";
        ui.gps.innerText = "Off";
        ui.gps.style.color = "#fff";
        ui.fps.innerText = "0 FPS";
    }

    function loop(now) {
        if(!isRunning) return;

        gl.uniform1f(locT, performance.now() * 0.001);
        gl.uniform2f(locR, canvas.width, canvas.height);
        gl.drawArrays(gl.TRIANGLES, 0, 6);

        frameCount++;
        if (now - lastTime >= 1000) {
            ui.fps.innerText = `${frameCount} FPS`;
            frameCount = 0;
            lastTime = now;
        }

        animationId = requestAnimationFrame(loop);
    }
</script>
</body>
</html>